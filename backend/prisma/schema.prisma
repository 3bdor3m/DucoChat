// Prisma Schema for Test App Backend

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String    @map("password_hash")
  fullName          String    @map("full_name")
  firstName         String?   @map("first_name")
  lastName          String?   @map("last_name")
  profileImage      String?   @map("profile_image")
  isActive          Boolean   @default(true) @map("is_active")
  isVerified        Boolean   @default(false) @map("is_verified")
  subscriptionTier  String    @default("free") @map("subscription_tier") // free, basic, premium
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  lastLogin         DateTime? @map("last_login")
  
  // Relations
  files             File[]
  chats             Chat[]
  passwordResets    PasswordReset[]
  notifications     Notification[]
  
  @@map("users")
}

// Password Reset model
model PasswordReset {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("password_resets")
}

// File model
model File {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  
  filename         String
  originalFilename String   @map("original_filename")
  fileType         String   @map("file_type")
  fileSize         BigInt   @map("file_size")
  storagePath      String   @map("storage_path")
  
  status           String   @default("processing") // uploading, processing, completed, error
  errorMessage     String?  @map("error_message")
  metadata         Json?
  
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  
  // Relations
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  contents         FileContent[]
  chats            Chat[]
  
  @@index([userId])
  @@index([status])
  @@map("files")
}

// File Content model (for RAG)
model FileContent {
  id              String   @id @default(uuid())
  fileId          String   @map("file_id")
  
  pageNumber      Int?     @map("page_number")
  paragraphNumber Int?     @map("paragraph_number")
  content         String   @db.Text
  
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")
  
  // Relations
  file            File            @relation(fields: [fileId], references: [id], onDelete: Cascade)
  messageSources  MessageSource[]
  
  @@index([fileId])
  @@index([pageNumber])
  @@map("file_contents")
}

// Chat model
model Chat {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String   @default("محادثة جديدة")
  fileId    String?  @map("file_id")
  
  settings  Json?    // creativity_level, search_mode, etc.
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  file      File?     @relation(fields: [fileId], references: [id], onDelete: SetNull)
  messages  Message[]
  
  @@index([userId])
  @@index([fileId])
  @@map("chats")
}

// Message model
model Message {
  id          String   @id @default(uuid())
  chatId      String   @map("chat_id")
  messageType String   @map("message_type") // user, bot
  content     String   @db.Text
  
  metadata    Json?    // model used, tokens, processing time, etc.
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relations
  chat        Chat            @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sources     MessageSource[]
  
  @@index([chatId])
  @@map("messages")
}

// Message Source model (linking messages to file content)
model MessageSource {
  id             String   @id @default(uuid())
  messageId      String   @map("message_id")
  fileContentId  String   @map("file_content_id")
  
  relevanceScore Float?   @map("relevance_score")
  createdAt      DateTime @default(now()) @map("created_at")
  
  // Relations
  message        Message     @relation(fields: [messageId], references: [id], onDelete: Cascade)
  fileContent    FileContent @relation(fields: [fileContentId], references: [id], onDelete: Cascade)
  
  @@index([messageId])
  @@index([fileContentId])
  @@map("message_sources")
}

// Notification model
model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  
  type      String   // 'success', 'error', 'warning', 'info'
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false) @map("is_read")
  
  metadata  Json?    // additional data like chatId, fileId, etc.
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// Activation Code model
model ActivationCode {
  id            String    @id @default(uuid())
  code          String    @unique
  
  tier          String
  isUsed        Boolean   @default(false) @map("is_used")
  usedBy        String?   @map("used_by")
  usedAt        DateTime? @map("used_at")
  
  expiresAt     DateTime? @map("expires_at")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  @@index([code])
  @@index([isUsed])
  @@map("activation_codes")
}